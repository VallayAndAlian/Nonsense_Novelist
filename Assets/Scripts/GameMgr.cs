using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using System;
using UnityEngine.EventSystems;
using UnityEngine.UI;

public class GameMgr : MonoSingleton<GameMgr>
{

    //关闭界面相关
    private GameObject exitPanel;
    GameObject exitObj;
    Button exitButton;
    Button cancelButton;
    bool hasOpenExit = false;

    //玩家已有的书库
    List<BookNameEnum> bookList = new List<BookNameEnum>();
    //玩家已有的，词语全部获取完毕的书库
    List<BookNameEnum> bookAllGetList = new List<BookNameEnum>();

    //战斗总牌库
    List<Type> wordList = new List<Type>();

    //当前未使用的牌的牌库
    List<Type> wordNowList = new List<Type>();

    //当前未使用的牌的牌库
    List<Type> wordHasUseList = new List<Type>();

    //当前触发的所有事件
    public List<string> happenEvent = new List<string>();




    [HideInInspector] public GameObject characterCanvas;


    private void Start()
    {
        characterCanvas = GameObject.Find("UICanvas");
        
        //界面设置
        if (characterCanvas != null)
            characterCanvas.SetActive(true);

        //退出菜单
        exitPanel = Resources.Load<GameObject>("UI/exitPanel");
        DontDestroyOnLoad(this.gameObject);

        //牌库
        InitCardList();
    }
    private void Update()
    {
        //退出菜单
        if (hasOpenExit) return;
        if (Input.GetKeyDown(KeyCode.Escape))
        {
            exitObj = Instantiate(exitPanel);
            Time.timeScale = 0f;
            hasOpenExit = true;
            exitButton = exitObj.transform.GetComponentsInChildren<Button>()[0];
            cancelButton = exitObj.transform.GetComponentsInChildren<Button>()[1];
            exitButton.onClick.AddListener(ExitButton);
            cancelButton.onClick.AddListener(BackToGame);
        }
    }



    #region exit菜单相关
    public void ExitButton()
    {
        Application.Quit();
    }
    public void BackToGame()
    {hasOpenExit = false;
        Destroy(exitObj.gameObject);
        Time.timeScale = 1f;
        
    }
    #endregion



    #region 新 牌库


    /// <summary>
    /// 牌库初始化
    /// </summary>
    void InitCardList()
    {
        wordList.Clear();
        wordNowList.Clear();
        wordHasUseList.Clear();

        happenEvent.Clear();

        //测试用
        wordList.AddRange(new Type[] { typeof(SheQunFengRong), typeof(ChanLuan), typeof(ShiWuFengRong) });

        //加入通用词组
        if(wordList==null)
            AddBookList(BookNameEnum.allBooks);
        RefreshNowList();
    }



    public List<Type> GetHasUsedList()
    {
        return wordHasUseList;
    }
    public List<Type> GetNowList()
    {

        if (wordNowList == null) //加入通用词组
            AddBookList(BookNameEnum.allBooks);
        return wordNowList;
    }
    public Type GetNowListOne()
    {
        int count = UnityEngine.Random.Range(0, wordNowList.Count);
        var _res = wordNowList[count];
        wordNowList.Remove(_res);
        wordHasUseList.Add(_res);
        RefreshNowList();
        return _res;
    }

    public List<Type> GetAllList()
    {
        return wordList;
    }


    //获取已有的书本列表
    public List<BookNameEnum> GetBookList()
    {

        return bookList;
    }

   

    /// <summary>
    /// 检测是否一本书的所有词组都已经获取。返回是或否
    /// </summary>
    /// <param name="_book"></param>
    /// <returns></returns>
   public  bool IsBookWordAllGet(BookNameEnum _book)
    {
        if (bookAllGetList.Contains(_book)) return true;

        List<Type> _typeList = GetBookList(_book);
        if (_typeList == null)
        {
            print("_typeList == null"); return true;
        }


        foreach (var _w in _typeList)
        {
            if (!wordList.Contains(_w))
            {
                return false;
            }
        }
        bookAllGetList.Add(_book);
        return true;
    }


    List<Type> GetBookList(BookNameEnum _book)
    {
        List<Type> _typeList = null;
        switch (_book)
        {
            case BookNameEnum.HongLouMeng:
                {
                    _typeList = AllSkills.hlmList_all;
                }
                break;
            case BookNameEnum.CrystalEnergy:
                {
                    _typeList = AllSkills.crystalList_all;
                }
                break;
            case BookNameEnum.Salome:
                {
                    _typeList = AllSkills.shaLeMeiList_all;
                }
                break;
            case BookNameEnum.ZooManual:
                {
                    _typeList = AllSkills.animalList_all;
                }
                break;
            case BookNameEnum.PHXTwist:
                {
                    _typeList = AllSkills.maYiDiGuoList_all;
                }
                break;
            case BookNameEnum.FluStudy:
                {
                    _typeList = AllSkills.liuXingBXList_all;
                }
                break;
            case BookNameEnum.EgyptMyth:
                {
                    _typeList = AllSkills.aiJiShenHuaList_all;
                }
                break;
            case BookNameEnum.ElectronicGoal:
                {
                    _typeList = AllSkills.humanList_all;
                }
                break;
            case BookNameEnum.allBooks:
                {
                    _typeList = AllSkills.commonList_all;
                }
                break;

        }
        return _typeList;
    }


    /// <summary>
    /// 随机获取书本中还未获取的词语
    /// </summary>
    /// <param name="_book"></param>
    public Type GetBookListNeedWordOne(BookNameEnum _book)
    {
        //已经没有没获得的词语了，返回null
        if (IsBookWordAllGet(_book)) return null;

        List<Type> _typeList = GetBookList(_book);
        if (_typeList == null)
        {
            print("_typeList == null");return null;
        }
        

        int _R = UnityEngine.Random.Range(0, _typeList.Count);

        while (wordList.Contains(_typeList[_R]))
        {
            _R = UnityEngine.Random.Range(0, _typeList.Count);

        }
        return _typeList[_R];
    }


    /// <summary>
    /// 刷新现有卡牌列表
    /// </summary>
    void RefreshNowList()
    {
        if (wordNowList.Count == 0)
        {
            wordNowList.AddRange(wordList);
            wordHasUseList.Clear();
        }
    }


    public void SetCombatStartList(List<Type> _list)
    {
        bookList.Clear();
        wordList.Clear();
        wordList = _list;
    }
    public void AddCombatStartList(List<Type> _list)
    {

        foreach (var _i in _list)
        {

            if (!wordList.Contains(_i))
            {
                _i.GetType();
                int _r = 1;
                //var count = _i.GetField("rarity").GetValue(null);
                //if (count != null) _r = (int)count;

                //for (int i = 0; i < _r; i++)
                //{
                wordList.Add(_i);
                //}
            }

        }
    }

    public void AddBookList(BookNameEnum _book)
    {
        switch (_book)
        {
            case BookNameEnum.HongLouMeng:
                {
                    if (!bookList.Contains(BookNameEnum.HongLouMeng))
                    {
                        //AddCombatStartList(AllSkills.hlmList_all);
                        bookList.Add(BookNameEnum.HongLouMeng);
                    }

                }
                break;
            case BookNameEnum.CrystalEnergy:
                {
                    if (!bookList.Contains(BookNameEnum.CrystalEnergy))
                    {
                        //AddCombatStartList(AllSkills.crystalList_all);
                        bookList.Add(BookNameEnum.CrystalEnergy);
                    }

                }
                break;
            case BookNameEnum.Salome:
                {
                    if (!bookList.Contains(BookNameEnum.Salome))
                    {
                        //AddCombatStartList(AllSkills.shaLeMeiList_all);
                        bookList.Add(BookNameEnum.Salome);
                    }

                }
                break;
            case BookNameEnum.ZooManual:
                {
                    if (!bookList.Contains(BookNameEnum.ZooManual))
                    {
                        //AddCombatStartList(AllSkills.animalList_all);
                        bookList.Add(BookNameEnum.ZooManual);
                    }

                }
                break;
            case BookNameEnum.PHXTwist:
                {
                    if (!bookList.Contains(BookNameEnum.PHXTwist))
                    {
                        // AddCombatStartList(AllSkills.maYiDiGuoList_all);
                        bookList.Add(BookNameEnum.PHXTwist);
                    }

                }
                break;
            case BookNameEnum.FluStudy:
                {
                    if (!bookList.Contains(BookNameEnum.FluStudy))
                    {
                        //AddCombatStartList(AllSkills.liuXingBXList_all);
                        bookList.Add(BookNameEnum.FluStudy);
                    }

                }
                break;
            case BookNameEnum.EgyptMyth:
                {
                    if (!bookList.Contains(BookNameEnum.EgyptMyth))
                    {
                        //AddCombatStartList(AllSkills.aiJiShenHuaList_all);
                        bookList.Add(BookNameEnum.EgyptMyth);
                    }
                }
                break;
            case BookNameEnum.ElectronicGoal:
                {
                    if (!bookList.Contains(BookNameEnum.ElectronicGoal))
                    {
                        //AddCombatStartList(AllSkills.humanList_all);
                        bookList.Add(BookNameEnum.ElectronicGoal);
                    }
                }
                break;
            case BookNameEnum.allBooks:
                {
                    if (!bookList.Contains(BookNameEnum.allBooks))
                    {
                        //AddCombatStartList(AllSkills.commonList_all);
                        bookList.Add(BookNameEnum.allBooks);
                    }

                }
                break;

        }
    }
    public bool HasBook(BookNameEnum _book)
    {
        if (bookList.Contains(_book))
            return true;
        return false;
    }
    #endregion


    #region 调用各种界面

    public void BookCanvasClickYes()
    {
        //进入放角色页面
        //生成面板
        if (characterCanvas != null)
            characterCanvas.SetActive(true);

        characterCanvas.GetComponentInChildren<CreateOneCharacter>().CreateNewCharacter(2);
    }
    #endregion
}
